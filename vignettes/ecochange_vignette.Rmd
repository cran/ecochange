---
title: "Introduction to the package ecochange"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to the package ecochange}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## Introduction
The R-package <span style="font-family:courier; font-size:1.15em;">ecochange</span> can assist users in monitoring ecosystem changes by computing biodiversity indicators related to structural essential biodiversity variables, including ecosystem areas, fractal dimension, and information-theory indices. The package processes polygons ---defined here as Regions of Interest (ROI)--- and Ecosystem Remote Sensing Products (ERSP).  <span style="font-family:courier; font-size:1.15em;">ecochange</span> harmonizes ERSP using the geometry of the ROI. The users can provide predefined polygons or implement the in-package functions to download ROI representing Geographic Administrative Data Maps (GADM).  The package can also download up to 16 ERSP available in three global databases: Forest Cover (GFC; Hansen et al., 2013), Tree-canopy Cover (TC; Sexton et al., 2013), and Water Surface (GWS; Pekel et al., 2017). Routines of the package integrate these and other predefined rastersif these data cover the extent of the processed ROI. In-package functions for statistical analysis and graphics provide tools to inform and visualize ecosystem changes. 

### Installation
The first requirement is to install and load the package in the R environment. Users can install the package and the dependencies running <span style="font-family:courier; font-size:1.15em;">install.packages()</span>. They can load it using either <span style="font-family:courier; font-size:1.15em;">require()</span> or <span style="font-family:courier; font-size:1.15em;">library()</span>. The package relies on several dependencies. It uses these to improve execution performance during spatial analysis. The users must be sure that all these are correctly installed.

```{r load_libraries_hidden,eval=TRUE,message=FALSE,results='hide',warning=FALSE}
# install.packages('ecochange')
require('ecochange')

dependencies <- c('ecochange','raster','rgdal','parallel', 'R.utils', 'rvest','xml2',
            'tidyverse','landscapemetrics','sf','dplyr','httr','getPass','gdalUtils',
            'gdalUtilities','rgeos','viridis', 'rasterVis','rlang', 'rasterDT')

# Values in the next list must be allx TRUE
sapply(dependencies, require, character.only = TRUE)

```

## Retrieving spatial data

Function <span style="font-family:courier; font-size:1.15em;">getrsp</span> can download the ERSP by processing the extent of a predefined region of interest (polygon geometry or GADM unit).

Here we implement <span style="font-family:courier; font-size:1.15em;">getrsp()</span> to download a polygon corresponding with a Colombian municipality. We control the function using three arguments: <span style="font-family:courier; font-size:1.15em;">level</span>, <span style="font-family:courier; font-size:1.15em;">country</span>, and <span style="font-family:courier; font-size:1.15em;">mc.cores</span>. These specify the GADM level (level 2 retrieves municipalities), the country ISO, and the number of cores, respectively.


### Harmonizing spatial data
Function <span style="font-family:courier; font-size:1.15em;">rsp2ebv</span> processes ERSP to produce harmonized raster-data sections with the cell values enclosed in an ROI.


```{r}
?rsp2ebv

ebv <- rsp2ebv('Chimichagua', lyrs = c('treecover2000','lossyear'), mc.cores = 2)
ebv
```

```{r, fig.height=3, fig.width=7}
plot(ebv)
```

## Deriving ecological changes
Function <span style="font-family:courier; font-size:1.15em;">echanges</span> can generate ecosystem-change maps by masking cell values in a layer of ecosystem changes over a target set of ecosystem variables.

This function can process the raster-data section previously harmonized with <span style="font-family:courier; font-size:1.15em;">rsp2ebv()</span>. It can also inherit arguments in <span style="font-family:courier; font-size:1.15em;">rsp2ebv()</span> and derive the data sections as an intermediate step.

By default, <span style="font-family:courier; font-size:1.15em;">echanges()</span> process the raster-data sections considering that the first layer is the target variable and the last layer is the change raster. If these layer positions are incorrect, the users must provide two additional arguments: <span style="font-family:courier; font-size:1.15em;">eco</span> and <span style="font-family:courier; font-size:1.15em;">change</span>. Such arguments provide regular expressions matching the names of the variables in the raster-data sections. For instance, we can use the arguments <span style="font-family:courier; font-size:1.15em;">eco</span> and <span style="font-family:courier; font-size:1.15em;">change</span>  to provide the expressions <span style="font-family:courier; font-size:1.15em;">'tree'</span> and <span style="font-family:courier; font-size:1.15em;">'loss'</span> corresponding with the layers <span style="font-family:courier; font-size:1.15em;">'treecover2000'</span> and <span style="font-family:courier; font-size:1.15em;">'lossyear'</span>, respectively.

Arguments <span style="font-family:courier; font-size:1.15em;">eco_range</span> and <span style="font-family:courier; font-size:1.15em;">change_vals</span> control the pixel values processed in the target variable and the change raster. Here we maintain the default in <span style="font-family:courier; font-size:1.15em;">eco_range</span> to process canopy covers between 1 and 100% and modify the argument <span style="font-family:courier; font-size:1.15em;">change_vals</span> to process pixels  0, 10, and 19 in the layer <span style="font-family:courier; font-size:1.15em;">'lossyear'</span>. These last values represent deforested areas observed during the years 2000, 2010, and 2019.

The output of <span style="font-family:courier; font-size:1.15em;">echanges()</span> is a RasterStack object with dimensionality defined by the values provided in <span style="font-family:courier; font-size:1.15em;">change_vals</span>. Here we obtain three layers corresponding with deforestations observed during the three years.

```{r, fig.height=3, fig.width=7}
ech <- echanges(ebv, eco = 'tree', echanges = 'loss',
                change_vals = c(0,10,19), mc.cores = 2)
plotebv(ech)
```
The plot suggests that canopy covers between 1-100% has decreased between 2000-2019. Let's compute the areas occupied by each canopy-cover value.

## Calculating biodiversity indicators

### Gauging indicators
In-package <span style="font-family:courier; font-size:1.15em;">gaugeIndicator()</span> calculates the biodiversity indicators by processing ecosystem-change maps from <span style="font-family:courier; font-size:1.15em;">echanges()</span>. It can also inherit arguments in <span style="font-family:courier; font-size:1.15em;">rsp2ebv()</span> and <span style="font-family:courier; font-size:1.15em;">echanges()</span> to derive the ecosystem-change maps.

Argument <span style="font-family:courier; font-size:1.15em;">metric</span> in the function provides the name of a biodiversity indicator. By default, <span style="font-family:courier; font-size:1.15em;">metric = 'area_ha'</span> makes the function to compute ecosystem areas (hectare). Besides, the users can provide hundreds of other abbreviations available in the landscape dependency (Hesselbarth et al., 2019).  Examples of these include <span style="font-family:courier; font-size:1.15em;">'condent'</span> and <span style="font-family:courier; font-size:1.15em;">'lsm_l_frac_mn'</span> which make the function to compute conditional entropy (dimensionless) and mean fractal dimension index for all patches in the raster (dimensionless).

The function output is a tibble of indicators ordered according to classes in the ecological variable. This output can be visualized using the in-package <span style="font-family:courier; font-size:1.15em;">plotind()</span>.

```{r, fig.height=7, fig.width=7}
?gaugeIndicator

# computating ecosystem areas (default)
gi <- gaugeIndicator(ech, mc.cores = 2)
gi

plotind(gi)
```

Forest areas in the municipality have decreased from to between 2000-2019. We can test if the observed deforestation has affected the landscape diversity by computing changes in conditional entropy.

### Sampling indicators across grids
In-package <span style="font-family:courier; font-size:1.15em;">sampleIndicator()</span> divides into fixed-size grids each of the scenes of a stack of ecosystem-spatial data and samples a biodiversity indicator by every grid. This function helps the users to visualize changes in the spatial distribution of the biodiversity indicators.

Default <span style="font-family:courier; font-size:1.15em;">metric = 'condent'</span> makes the function to compute conditional entropy (dimensionless).  Users can define any other biodiversity indicator. Here we calculate changes in conditional entropy to measure ecosystem degradation in terms of changes of pixel adjacency and canopy-cover diversity. Default <span style="font-family:courier; font-size:1.15em;">side</span> (missing) can find an optimum grid size (m) that returns at least a numeric value in one grid by scene. The users can change the <span style="font-family:courier; font-size:1.15em;">side</span> default to specify a customized grid size. The function output is a RasterStack object with the same number of scenes of the ecosystem-change map. For instance,

```{r, fig.height=3, fig.width=7,message=FALSE,results='hide',warning=FALSE}
si_ent <- sampleIndicator(ech, mc.cores = 2)
si_ent
plotebv(si_ent)
```

Changes in conditional entropy across the ecosystem-change map between 2000-2019 remained relatively constant. Let's compute means and standard deviations.

### Calculating statistics
Function <span style="font-family:courier; font-size:1.15em;">EBVstats</span> can map statistics over scenes in RasterStack objects. Here we implement <span style="font-family:courier; font-size:1.15em;"> EBVstats()</span> to derive statistics for the changes of entropy observed across the grid maps.

```{r, fig.height=3, fig.width=7}
##Statistics for changes in entropy:
sts <- EBVstats(si_ent)
sts

## In-package bar plot method:
barplot(sts)
```

Averages and standard deviations for the grids suggest the relationship between changes in pixel adjacency and canopy-cover diversity between 2000-2019 has remained relatively constant across the municipality.

## Conclusion
This is a brief introduction to the package <span style="font-family:courier; font-size:1.15em;">ecochange</span>. There are other arguments to control the package functionality. For instance, the function <span style="font-family:courier; font-size:1.15em;">listGP</span> can print detailed information about ERSP downloadable with the package. Likewise, the function <span style="font-family:courier; font-size:1.15em;">echanges()</span> includes other arguments, e.g., <span style="font-family:courier; font-size:1.15em;">'sp_dist'</span>, <span style="font-family:courier; font-size:1.15em;">'get_unaffected'</span>,  and <span style="font-family:courier; font-size:1.15em;">'binary_output'</span>; these arguments help the users to provide an alternative raster indicating a species distribution range, or to switch analyses focussing on affected/unaffected areas, or to format the outputs into binary layers, respectively. Please refer to the package documentation for more information.

## Citing ecochange
The package can be cited using the citation() function. Please cite ecochange appropriately in your work.

```{r, eval=FALSE}
citation('ecochange')
```

## References
Hansen, M. C., Potapov, P. V., Moore, R., Hancher, M., Turubanova, S. A. A., Tyukavina, A., ... & Kommareddy, A. (2013). High-resolution global maps of 21st-century forest cover change. science, 342(6160), 850-853.

Hesselbarth, M.H., Sciaini, M., With, K.A., Wiegand, K., & Nowosad, J., (2019). landscapemetrics: an open-source R tool to calculate landscape metrics. Ecography.

Pekel, J. F., Belward, A., & Gorelick, N.  (2017). Global Water Surface Dynamics: Toward a Near Real Time Monitoring Using Landsat and Sentinel Data. In AGU Fall Meeting Abstracts.

Sexton, J. O., Song, X. P., Feng, M., Noojipady, P., Anand, A., Huang, C., ... & Townshend, J. R. (2013). Global, 30-m resolution continuous fields of tree cover: Landsat-based rescaling of MODIS vegetation continuous fields with lidar-based estimates of error. International Journal of Digital Earth, 6(5), 427-448.


